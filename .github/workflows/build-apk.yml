name: Build Equidroid APK

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

env:
  JAVA_VERSION: '17'
  ANDROID_COMPILE_SDK: '34'
  ANDROID_BUILD_TOOLS: '34.0.0'

jobs:
  # ============== BUILD APK ==============
  build-apk:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: â˜• Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: gradle
    
    - name: ğŸ¤– Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: âœ… Accept Android licenses
      run: yes | sdkmanager --licenses || true
    
    - name: ğŸ“¦ Install Android SDK components
      run: |
        sdkmanager "platforms;android-${{ env.ANDROID_COMPILE_SDK }}"
        sdkmanager "build-tools;${{ env.ANDROID_BUILD_TOOLS }}"
    
    - name: ğŸ“ Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: ğŸ” Validate Gradle wrapper
      uses: gradle/wrapper-validation-action@v2
    
    - name: ğŸ§¹ Clean project
      run: ./gradlew clean --stacktrace
    
    - name: ğŸ“‹ Check Gradle files
      run: |
        echo "Checking for build.gradle files..."
        find . -name "build.gradle*" -type f
    
    - name: ğŸ”¨ Build Debug APK
      if: github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == ''
      run: ./gradlew assembleDebug --stacktrace --info
      continue-on-error: false
    
    - name: ğŸ”¨ Build Release APK (unsigned)
      if: github.event.inputs.build_type == 'release' || startsWith(github.ref, 'refs/tags/v')
      run: ./gradlew assembleRelease --stacktrace --info
      continue-on-error: false
    
    - name: ğŸ“ Get version info
      id: version
      run: |
        # Try multiple ways to get version
        if [ -f "app/build.gradle.kts" ]; then
          VERSION_NAME=$(grep -E "versionName\s*=\s*" app/build.gradle.kts | head -1 | sed -E 's/.*versionName\s*=\s*"([^"]+)".*/\1/' || echo "1.0.0")
          VERSION_CODE=$(grep -E "versionCode\s*=\s*" app/build.gradle.kts | head -1 | sed -E 's/.*versionCode\s*=\s*([0-9]+).*/\1/' || echo "1")
          MIN_SDK=$(grep -E "minSdk\s*=\s*" app/build.gradle.kts | head -1 | sed -E 's/.*minSdk\s*=\s*([0-9]+).*/\1/' || echo "19")
        elif [ -f "app/build.gradle" ]; then
          VERSION_NAME=$(grep "versionName" app/build.gradle | head -1 | awk -F'"' '{print $2}' || echo "1.0.0")
          VERSION_CODE=$(grep "versionCode" app/build.gradle | head -1 | awk '{print $2}' || echo "1")
          MIN_SDK=$(grep "minSdkVersion" app/build.gradle | head -1 | awk '{print $2}' || echo "19")
        else
          VERSION_NAME="1.0.0"
          VERSION_CODE="1"
          MIN_SDK="19"
        fi
        
        echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
        echo "min_sdk=$MIN_SDK" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Version: $VERSION_NAME ($VERSION_CODE)"
        echo "ğŸ“± Min SDK: $MIN_SDK"
    
    - name: ğŸ“¤ Upload Debug APK
      if: always() && hashFiles('app/build/outputs/apk/debug/*.apk') != ''
      uses: actions/upload-artifact@v4
      with:
        name: equidroid-debug-v${{ steps.version.outputs.version_name }}
        path: app/build/outputs/apk/debug/*.apk
        retention-days: 30
        if-no-files-found: warn
    
    - name: ğŸ“¤ Upload Release APK
      if: always() && hashFiles('app/build/outputs/apk/release/*.apk') != ''
      uses: actions/upload-artifact@v4
      with:
        name: equidroid-release-v${{ steps.version.outputs.version_name }}
        path: app/build/outputs/apk/release/*.apk
        retention-days: 90
        if-no-files-found: warn
    
    - name: ğŸ“Š APK Info
      if: always()
      run: |
        echo "ğŸ“ Build outputs:"
        find app/build/outputs/apk -type f -name "*.apk" 2>/dev/null || echo "No APK files found"
        echo ""
        if [ -d "app/build/outputs/apk/debug" ]; then
          echo "ğŸ“± Debug APK:"
          ls -lh app/build/outputs/apk/debug/*.apk 2>/dev/null || echo "No debug APK"
        fi
        echo ""
        if [ -d "app/build/outputs/apk/release" ]; then
          echo "ğŸ“± Release APK:"
          ls -lh app/build/outputs/apk/release/*.apk 2>/dev/null || echo "No release APK"
        fi

  # ============== BUILD PWA ==============
  build-pwa:
    name: Build PWA Package
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ“¦ Package PWA files
      run: |
        mkdir -p pwa-package
        
        # Copy files if they exist
        [ -f "index.html" ] && cp index.html pwa-package/ || echo "âš ï¸ index.html not found"
        [ -f "manifest.json" ] && cp manifest.json pwa-package/ || echo "âš ï¸ manifest.json not found"
        [ -f "sw.js" ] && cp sw.js pwa-package/ || echo "âš ï¸ sw.js not found"
        [ -f "config.json" ] && cp config.json pwa-package/ || echo "âš ï¸ config.json not found"
        [ -f "equicord-inject.js" ] && cp equicord-inject.js pwa-package/ || echo "âš ï¸ equicord-inject.js not found"
        
        # Create icons directory
        mkdir -p pwa-package/icons
        
        # Create simple SVG icons
        for size in 72 96 128 144 152 192 384 512; do
          cat > pwa-package/icons/icon-${size}.svg << EOF
        <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 100 100">
          <defs>
            <linearGradient id="g" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="#5865F2"/>
              <stop offset="100%" stop-color="#EB459E"/>
            </linearGradient>
          </defs>
          <rect width="100" height="100" rx="20" fill="url(#g)"/>
          <text x="50" y="68" text-anchor="middle" fill="white" font-size="45" font-weight="bold" font-family="Arial">E</text>
        </svg>
        EOF
        done
        
        echo "ğŸ“ PWA Package contents:"
        ls -la pwa-package/ || echo "Empty package"
    
    - name: ğŸ“¤ Upload PWA Package
      uses: actions/upload-artifact@v4
      with:
        name: equidroid-pwa
        path: pwa-package/
        retention-days: 30
        if-no-files-found: warn

  # ============== CREATE RELEASE ==============
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-apk, build-pwa]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ğŸ“¥ Download APK artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: equidroid-*
        path: ./artifacts
    
    - name: ğŸ“‹ List artifacts
      run: |
        echo "ğŸ“¦ Downloaded artifacts:"
        find ./artifacts -type f 2>/dev/null || echo "No artifacts found"
    
    - name: ğŸš€ Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Equidroid ${{ github.ref_name }}
        body: |
          ## ğŸ“± Equidroid ${{ github.ref_name }}
          
          Discord + Equicord Client Mod cho Android
          
          ### ğŸ“¥ Downloads
          - **Debug APK**: DÃ nh cho testing
          - **Release APK**: Báº£n á»•n Ä‘á»‹nh
          - **PWA Package**: DÃ¹ng vá»›i PWABuilder
          
          ### âœ¨ TÃ­nh nÄƒng
          - Discord WebView vá»›i Equicord injection
          - Plugin system (Message Logger, Better Roles, No Track...)
          - Custom CSS support
          - Offline mode
          
          ### ğŸ“ CÃ i Ä‘áº·t
          1. Táº£i APK phÃ¹ há»£p
          2. Cho phÃ©p "Unknown Sources"
          3. CÃ i Ä‘áº·t vÃ  má»Ÿ app
          
          ---
          Made with â¤ï¸ for Discord
        files: |
          ./artifacts/**/*.apk
        draft: false
        prerelease: false
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============== NOTIFY ==============
  notify:
    name: Build Notification
    runs-on: ubuntu-latest
    needs: [build-apk]
    if: always()
    
    steps:
    - name: ğŸ“¢ Build Status
      run: |
        if [ "${{ needs.build-apk.result }}" == "success" ]; then
          echo "âœ… Build thÃ nh cÃ´ng!"
          echo "ğŸ“± APK Ä‘Ã£ sáºµn sÃ ng Ä‘á»ƒ táº£i xuá»‘ng tá»« Artifacts"
        else
          echo "âŒ Build tháº¥t báº¡i!"
          echo "Vui lÃ²ng kiá»ƒm tra logs Ä‘á»ƒ biáº¿t chi tiáº¿t"
          echo "Káº¿t quáº£: ${{ needs.build-apk.result }}"
        fi
